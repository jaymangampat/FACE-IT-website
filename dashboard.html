<!DOCTYPE html>
<html lang="en" class="light-style" dir="ltr" data-theme="theme-default" data-assets-path="../assets/"
  data-template="vertical-menu-template-free">

<head>
  <meta charset="utf-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />

  <title>FACE-IT | Dashboard</title>

  <meta name="description" content="" />

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="../assets/img/favicon/logofinal.png" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
    rel="stylesheet" />

  <!-- Icons. Uncomment required icon fonts -->
  <link rel="stylesheet" href="../assets/vendor/fonts/boxicons.css" />

  <!-- Core CSS -->
  <link rel="stylesheet" href="../assets/vendor/css/core.css" class="template-customizer-core-css" />
  <link rel="stylesheet" href="../assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
  <link rel="stylesheet" href="../assets/css/demo.css" />

  <!-- Vendors CSS -->
  <link rel="stylesheet" href="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />

  <link rel="stylesheet" href="../assets/vendor/libs/apex-charts/apex-charts.css" />

  <!-- Page CSS -->

  <!-- Helpers -->
  <script src="../assets/vendor/js/helpers.js"></script>

  <!--! Template customizer & Theme config files MUST be included after core stylesheets and helpers.js in the <head> section -->
  <!--? Config:  Mandatory theme config file contain global vars & default theme options, Set your preferred theme option in this file.  -->
  <script src="../assets/js/config.js"></script>
</head>

<body>
  <!-- Layout wrapper -->
  <div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
      <!-- Menu -->

      <aside id="layout-menu" class="layout-menu menu-vertical menu bg-menu-theme">
        <div class="app-brand demo">
          <a href="dashboard.html" class="app-brand-link">
            <span class="app-brand-logo demo">
              <a href="dashboard.html" class="app-brand-link">
                <span class="app-brand-logo demo">
                  <img src="../assets/img/favicon/logofinal.png" style="width: 40px;">
                </span>
              </a>

              <a href="javascript:void(0);" class="layout-menu-toggle menu-link text-large ms-auto d-block d-xl-none">
                <i class="bx bx-chevron-left bx-sm align-middle"></i>
              </a>
            </span>
            <span class="app-brand-text demo menu-text fw-bolder ms-2">Face-IT</span>
          </a>

          <a href="javascript:void(0);" class="layout-menu-toggle menu-link text-large ms-auto d-block d-xl-none">
            <i class="bx bx-chevron-left bx-sm align-middle"></i>
          </a>
        </div>

        <div class="menu-inner-shadow"></div>

        <ul class="menu-inner py-1">
          <li class="menu-header small text-uppercase">
            <span class="menu-header-text">Pages</span>
          </li>
          <!-- Dashboard -->
          <li class="menu-item active">
            <a href="dashboard.html" class="menu-link">
              <i class="menu-icon tf-icons bx bx-stats"></i>
              <div data-i18n="Analytics">Dashboard</div>
            </a>
          </li>
          <li class="menu-item">
            <a href="realtime-video.html" class="menu-link">
              <i class="menu-icon tf-icons bx bx-video"></i>
              <div data-i18n="Container">Real-time Video</div>
            </a>
          </li>

          <li class="menu-header small text-uppercase">
            <span class="menu-header-text">Account</span>
          </li>
          <li class="menu-item">
            <a href="javascript:void(0);" class="menu-link menu-toggle">
              <i class="menu-icon tf-icons bx bx-dock-top"></i>
              <div data-i18n="Account Settings">Account Settings</div>
            </a>
            <ul class="menu-sub">
              <li class="menu-item">
                <a href="pages-account-profile.html" class="menu-link">
                  <div data-i18n="Account">My Profile</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="pages-account-settings.html" class="menu-link">
                  <div data-i18n="Notifications">Settings</div>
                </a>
              </li>
            </ul>
          </li>
          <li class="menu-header small text-uppercase">
            <span class="menu-header-text">About Us</span>
          </li>
          <li class="menu-item">
            <a href="about-us.html" class="menu-link">
              <i class="menu-icon tf-icons bx bx-help-circle"></i>
              <div>About Us</div>
            </a>
          </li>
      </aside>
      <!-- / Menu -->

      <!-- Layout container -->
      <div class="layout-page">
        <!-- Navbar -->

        <nav
          class="layout-navbar container-xxl navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme"
          id="layout-navbar">
          <div class="layout-menu-toggle navbar-nav align-items-xl-center me-3 me-xl-0 d-xl-none">
            <a class="nav-item nav-link px-0 me-xl-4" href="javascript:void(0)">
              <i class="bx bx-menu bx-sm"></i>
            </a>
          </div>

          <div class="navbar-nav-right d-flex align-items-center" id="navbar-collapse">
            <ul class="navbar-nav flex-row align-items-center ms-auto">

              <!-- User -->
              <li class="nav-item navbar-dropdown dropdown-user dropdown">
                <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown">
                  <div class="avatar avatar-online">
                    <img id="userPhotoDisplay" src="../assets/img/avatars/avatar.png" alt
                      class="w-px-49 h-auto rounded-circle" />
                  </div>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <a class="dropdown-item" href="pages-account-profile.html">
                      <div class="d-flex">
                        <div class="flex-shrink-0 me-3">
                          <div class="avatar avatar-online">
                            <img id="userPhotoDisplay1" src="../assets/img/avatars/avatar.png" alt
                              class="w-px-45 h-auto rounded-circle" />
                          </div>
                        </div>
                        <div class="flex-grow-1" id="userDisplay">
                          <span class="fw-semibold d-block" id="userNameDisplay"></span>
                          <small class="text-muted" id="userEmailDisplay"></small>
                        </div>
                      </div>
                    </a>
                  </li>
                  <li>
                    <div class="dropdown-divider"></div>
                  </li>
                  <li>
                    <a class="dropdown-item" href="pages-account-settings.html">
                      <i class="bx bx-cog me-2"></i>
                      <span class="align-middle">Settings</span>
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="about-us.html">
                      <span>
                        <i class="bx bx-help-circle me-2"></i>
                        <span class="align-middle">About Us</span>
                      </span>
                    </a>
                  </li>
                  <li>
                    <div class="dropdown-divider"></div>
                  </li>
                  <li>
                    <a class="dropdown-item" id="logout" style="cursor: pointer;">
                      <i class="bx bx-power-off me-2"></i>
                      <span class="align-middle">Log Out</span>
                    </a>
                  </li>
                </ul>
              </li>
              <!--/ User -->
            </ul>
          </div>
        </nav>

        <!-- / Navbar -->

        <!-- Content wrapper -->
        <div class="content-wrapper">
          <!-- Content -->

          <div class="container-xxl flex-grow-1 container-p-y">
            <div class="row">
              <div class="col-lg-12 mb-4 order-0">
                <div class="card">
                  <div class="d-flex align-items-end row">
                    <div class="col-sm-7">
                      <div class="card-body">
                        <h5 class="card-title text-primary" id="greeting"></h5>
                        <p class="mb-4">
                          You've achieved a <span id="percentageInsight" class="fw-bold"></span> customer feedback level
                          in the "<span id="percentageEmotion" class="fw-bold"></span>" category
                          today, marking the highest rate.
                        </p>

                        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal"
                          data-bs-target="#exLargeModal" id="showModalButton">
                          View Insights
                        </button>
                      </div>
                    </div>
                    <!-- Extra Large Modal -->
                    <div class="modal fade" id="exLargeModal" tabindex="-1" aria-hidden="true">
                      <div class="modal-dialog modal-xl" role="document">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel4">Insights</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body">
                            <div class="insightBox">
                              <canvas id="emoStackBarChart"></canvas>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-sm-5 text-center text-sm-left">
                      <div class="card-body pb-0 px-0 px-md-4">
                        <img src="../assets/img/illustrations/man-with-laptop-light.png" height="140"
                          alt="View Badge User" data-app-dark-img="illustrations/man-with-laptop-dark.png"
                          data-app-light-img="illustrations/man-with-laptop-light.png" />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Feedback Over Time -->
              <div class="col-12 col-lg-12 order-2 order-md-3 order-lg-2 mb-4">
                <div class="card">
                  <div class="row row-bordered g-0">
                    <div class="card-header d-flex align-items-center justify-content-between pb-0">
                      <div class="col-md-12">
                        <h5 class="m-0 me-2 mt-2">Feedback Over Time</h5>
                        <div class="chart-container">
                          <div class="box"> <!-- Set the desired width for your chart -->
                            <canvas id="emotionLineChart"></canvas>
                          </div>
                        </div>                        
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Feedback Over Time -->
              <div class="row">
                <!-- Emotion Counts -->
                <div class="col-md-6 col-lg-6 col-xl-6 order-0 mb-4">
                  <div class="card h-100">
                    <div class="card-header d-flex align-items-center justify-content-between pb-0">
                      <div class="card-title mb-0">
                        <h5 class="m-0 me-2">Emotion Counts</h5>
                        <small>Day-per-Day</small>
                      </div>
                    </div>
                    <div class="card-body" class="text-center">
                      <div class="d-flex justify-content-center align-items-center mb-2">
                        <div class="d-flex flex-column align-items-center gap-1">
                          <h1 class="m-3 mb-0 fw-bold" id="emotionCountsTotal"></h1>
                          <span class="text-center mb-3">Total Emotions Count</span>
                          <div class="dropdown">
                            <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button"
                              id="emotionCountDate" data-bs-toggle="dropdown" aria-haspopup="true"
                              aria-expanded="false">
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="emotionCountDate"
                              id="emotionCountDatePrevious">
                              <a class="dropdown-item" id="previousDate1"></a>
                              <a class="dropdown-item" id="previousDate2"></a>
                              <a class="dropdown-item" id="previousDate3"></a>
                            </ul>
                          </div>
                          <div style="max-width: 400px; width: 100%;"><canvas id="emotionChart"></canvas></div>
                        </div>
                      </div>
                      <ul class="p-0 m-0">
                        <li class="d-flex mb-4 pb-1">
                          <div class="avatar flex-shrink-0 me-3">
                            <span class="avatar-initial rounded bg-label-info"><i
                                class="bx bx-happy-beaming"></i></span>
                          </div>
                          <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                            <div class="me-2">
                              <h4 class="mb-0">Happy</h4>
                            </div>
                            <div class="user-progress">
                              <small class="fw-semibold" id="happyCount"></small>
                            </div>
                          </div>
                        </li>
                        <li class="d-flex mb-4 pb-1">
                          <div class="avatar flex-shrink-0 me-3">
                            <span class="avatar-initial rounded bg-label-warning"><i class="bx bx-meh"></i></span>
                          </div>
                          <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                            <div class="me-2">
                              <h4 class="mb-0">Neutral</h4>
                            </div>
                            <div class="user-progress">
                              <small class="fw-semibold" id="neutralCount"></small>
                            </div>
                          </div>
                        </li>
                        <li class="d-flex mb-4 pb-1">
                          <div class="avatar flex-shrink-0 me-3">
                            <span class="avatar-initial rounded bg-label-danger"><i class="bx bx-angry"></i></span>
                          </div>
                          <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                            <div class="me-2">
                              <h4 class="mb-0">Angry</h4>
                            </div>
                            <div class="user-progress">
                              <small class="fw-semibold" id="angryCount"></small>
                            </div>
                          </div>
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
                <!--/ Emotion Counts -->

                <!-- Total Emotion Counts -->
                <div class="col-md-6 col-lg-6 order-1 mb-4">
                  <div class="card h-100">
                    <div class="card-header d-flex align-items-center justify-content-between pb-0">
                      <div class="card-title mb-0">
                        <h5 class="m-0 me-2">Emotion Counts</h5>
                        <small>Monthly Stats</small>
                      </div>
                    </div>
                    <div class="card-body">
                      <div class="tab-content p-0">
                        <div class="tab-pane fade show active" id="navs-tabs-line-card-income" role="tabpanel">
                          <canvas id="verticalBarChart" width="400" height="630"></canvas>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!--/ Total Emotion Counts -->
              </div>
            </div>
            <!-- / Content -->

            <div class="content-backdrop fade"></div>
          </div>
          <!-- Content wrapper -->
        </div>
        <!-- / Layout page -->
      </div>

      <!-- Overlay -->
      <div class="layout-overlay layout-menu-toggle"></div>
    </div>
    <!-- / Layout wrapper -->

    <!-- Core JS -->
    <!-- build:js assets/vendor/js/core.js -->
    <script src="../assets/vendor/libs/jquery/jquery.js"></script>
    <script src="../assets/vendor/libs/popper/popper.js"></script>
    <script src="../assets/vendor/js/bootstrap.js"></script>
    <script src="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>

    <script src="../assets/vendor/js/menu.js"></script>
    <!-- endbuild -->

    <!-- Vendors JS -->
    <script src="../assets/vendor/libs/apex-charts/apexcharts.js"></script>

    <!-- Main JS -->
    <script src="../assets/js/main.js"></script>

    <!-- Page JS -->
    <script src="../assets/js/dashboards-analytics.js"></script>

    <!-- Chart JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-analytics.js";
      import { getAuth, signOut, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-auth.js"; // Import Firebase Authentication
      import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/10.3.1/firebase-database.js';

      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyD61AGO2ZR8plHMvFUCLrCiCe9pB57XaB8",
        authDomain: "login-capstone-d6ae0.firebaseapp.com",
        databaseURL:"https://login-capstone-d6ae0-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "login-capstone-d6ae0",
        storageBucket: "login-capstone-d6ae0.appspot.com",
        messagingSenderId: "864644609365",
        appId: "1:864644609365:web:e8759207e02745ed83ebdc",
        measurementId: "G-TQP6RYWEG7"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const database = getDatabase(app);
      const auth = getAuth(app); // Initialize Firebase Authentication
      const user = auth.currentUser;

      document.getElementById("logout").addEventListener("click", () => {

      // Sign out the current user
        signOut(auth)
          .then(() => {
            // Sign-out successful.
            // You can redirect the user to a sign-in page or perform other actions here.
            console.log("User signed out.");
            window.location.href = "index.html"; // Redirect to the login page (replace with your desired URL)
          })
          .catch((error) => {
            // An error happened.
            console.error("Error signing out:", error);
          });
      });

      auth.onAuthStateChanged(async (user) => {
  if (user) {
    try {
      const userName = user.displayName;
      const userEmail = user.email;
      const userDisplay = document.getElementById("userDisplay");
      const userNameDisplay = userDisplay.querySelector("#userNameDisplay");
      const userEmailDisplay = userDisplay.querySelector("#userEmailDisplay");
      const userPhotoURL = user.photoURL;
      const userPhotoDisplay = document.getElementById("userPhotoDisplay");
      const userPhotoDisplay1 = document.getElementById("userPhotoDisplay1");

      if (userName) {
        userNameDisplay.textContent = userName;
      } else if (userEmail) {
        const atIndex = userEmail.indexOf("@");
        if (atIndex !== -1) {
          const emailPrefix = userEmail.substring(0, atIndex);
          userNameDisplay.textContent = emailPrefix;
        } else {
          userNameDisplay.textContent = userEmail;
        }
      }

      if (userEmailDisplay) {
        userEmailDisplay.textContent = userEmail;
        const greetingElement = document.getElementById('greeting');

        if (greetingElement) {
          greetingElement.textContent = `Hello there, ${userNameDisplay.textContent}! 👋`;
        }
      }

      if (userPhotoURL) {
        if (userPhotoDisplay) {
          userPhotoDisplay.src = userPhotoURL;
        }
        if (userPhotoDisplay1) {
          userPhotoDisplay1.src = userPhotoURL;
        }
      } else {
        const googleProfilePicture = user.providerData.find((provider) => {
          return provider.providerId === "google.com";
        }).photoURL;

        if (userPhotoDisplay && googleProfilePicture) {
          userPhotoDisplay.src = googleProfilePicture;
        }
        if (userPhotoDisplay1 && googleProfilePicture) {
          userPhotoDisplay1.src = googleProfilePicture;
        }
      }

      const userFirstName = userName.split(' ')[0];
      const greetingElement = document.getElementById('greeting');

      if (greetingElement) {
        greetingElement.textContent = `Hello there, ${userFirstName}! 👋`;
      }
    } catch (error) {
      console.error("Error processing user data:", error);
    }
  } else {
    window.location.href = "index.html";
  }

      // Get the user's Firebase email
      const userEmail = auth.currentUser.email;

      // Get the current date
      const currentDate = new Date();

      // Convert the date to a string in the format "YYYY-MM-DD"
      const dateString = currentDate.toISOString().split('T')[0];

      // Get a reference to the data path where your emotion data is stored
      const dataRef = ref(database, `${dateString}/${userEmail.split('@')[0]}/emotions`); // Replace with your data path
  
      function updateChartData(datePath) {
  // Make sure datePath is a string
  const dateString = String(datePath);

  const userDateRef = ref(database, `${datePath}/emotions`);

  onValue(userDateRef, (snapshot) => {
    const data = snapshot.val();
    // Destroy existing chart if it exists
    const existingChart = Chart.getChart("emotionChart");
    if (existingChart) {
      existingChart.destroy();
    }

      // Calculate total emotions
      const totalEmotions = (data.happy || 0) + (data.neutral || 0) + (data.angry || 0);

      const chartData = {
        labels: ['Happy', 'Neutral', 'Angry'],
        datasets: [{
          data: [data.happy || 0, data.neutral || 0, data.angry || 0],
          backgroundColor: ['#696cff', '#ffab00', '#FF3e1d'],
        }],
      };

      const doughnutOptions = {
        responsive: true,         // Make the chart responsive
        maintainAspectRatio: false, // Don't maintain aspect ratio
      };
      // Update chart
      const ctx = document.getElementById('emotionChart').getContext('2d');
      const myChart = new Chart(ctx, {
        type: 'doughnut',
        data: chartData,
        options: doughnutOptions,
      });

      // Update emotion counts
      document.getElementById('happyCount').textContent = data.happy || 0;
      document.getElementById('neutralCount').textContent = data.neutral || 0;
      document.getElementById('angryCount').textContent = data.angry || 0;

       // Update total emotions
       document.getElementById('emotionCountsTotal').textContent = totalEmotions;
    });
  }
  updateChartData();
  const dateRef = ref(database);
  const dateButton = document.getElementById('emotionCountDate');
  const dropdownMenu = document.querySelector('#emotionCountDatePrevious');

  // Fetch all dates from Firebase
  onValue(dateRef, (snapshot) => {
    const dates = snapshot.val();

    if (dates) {
      // Clear previous dropdown items
      dropdownMenu.innerHTML = '';

      // Iterate over dates
      Object.keys(dates).forEach((date, index) => {
        const accountName = userEmail.split('@')[0];
        const userDateRefPath = `${date}/${accountName}`;

        if (dates[date][accountName]) {
        const dropdownItemId = `previousDate${index + 1}`;
        const dropdownItem = document.createElement('a');
        dropdownItem.classList.add('dropdown-item');
        dropdownItem.textContent = date;

        dropdownItem.addEventListener('click', () => {
    // Update the selected date and fetch data for that date
    dateButton.textContent = date;
    const dateString = String(date); // Ensure date is a string

    // Log the dateString to check if it's correct
    console.log('dateString:', dateString);

    // Construct the correct path to the data
    const userDateRefPath = `${dateString}/${userEmail.split('@')[0]}`;
    
    // Log the userDateRefPath to check if it's correct
    console.log('userDateRefPath:', userDateRefPath);

    // Update chart data for the selected date
    updateChartData(userDateRefPath);
  });

        dropdownMenu.appendChild(dropdownItem);
}
      });

  // Trigger a click event on the latest date item
  const latestDateItem = dropdownMenu.lastChild;
      if (latestDateItem) {
        latestDateItem.click();
      }
    } else {
      console.log("No data found in the snapshot");
    }
  });
  
  function calculateHighestPercentage(chart) {
        const data = chart.data.datasets.map(dataset => dataset.data);
        const highestPercentages = data[0].map((_, index) => {
            const percentages = data.map(dataset => dataset[index]);
            return Math.max(...percentages);
        });
        return highestPercentages;
    }

// Function to fetch dates from Firebase and update the chart
function fetchDatesAndChart() {
  // Get a reference to the data path where your emotion data is stored
  const linedataRef = ref(database);

  // Initialize arrays for data and labels
  const dateLabels = [];
  const satisfiedData = [];
  const neutralData = [];
  const notSatisfiedData = [];

  // Fetch the dates and update the chart
  onValue(linedataRef, (snapshot) => {
    const linedata = snapshot.val();

    if (linedata) {
      // Initialize arrays for data and labels for each data retrieval
      const tempDateLabels = [];
      const tempSatisfiedData = [];
      const tempNeutralData = [];
      const tempNotSatisfiedData = [];

      // Loop through the dates and accumulate data
      Object.keys(linedata).forEach((date) => {
        // Check if account name is available for the current date
        const accountName = userEmail.split('@')[0];
        if (!accountName) {
          // Skip this date if account name is empty
          return;
        }

        // Create a reference to the emotion data for the current date
        const dateDataRef = ref(database, `${date}/${accountName}/emotions`);

        // Fetch the emotion data for the current date
        onValue(dateDataRef, (dateSnapshot) => {
          const dateData = dateSnapshot.val();

          if (dateData) {
            // Extract the emotion data for each date
            const satisfied = dateData.happy || 0;
            const neutral = dateData.neutral || 0;
            const notSatisfied = dateData.angry || 0;

            // Calculate percentages and ensure they don't exceed 100%
            const totalEmotions = satisfied + neutral + notSatisfied;
            const satisfiedPercentage = (satisfied / totalEmotions) * 100;
            const neutralPercentage = (neutral / totalEmotions) * 100;
            const notSatisfiedPercentage = (notSatisfied / totalEmotions) * 100;

            // Add date labels and emotion data to temporary arrays
            tempDateLabels.push(date);
            tempSatisfiedData.push(satisfiedPercentage);
            tempNeutralData.push(neutralPercentage);
            tempNotSatisfiedData.push(notSatisfiedPercentage);
          } else {
            // Handle the case where data is undefined, set it to null or take appropriate action
            tempDateLabels.push("No Data Available");
            tempSatisfiedData.push(null);
            tempNeutralData.push(null);
            tempNotSatisfiedData.push(null);
          }

          // Check if this is the last date, and if so, update the main arrays and chart
          if (tempDateLabels.length === Object.keys(linedata).length) {
            dateLabels.push(...tempDateLabels);
            satisfiedData.push(...tempSatisfiedData);
            neutralData.push(...tempNeutralData);
            notSatisfiedData.push(...tempNotSatisfiedData);

            // Check if this is the last data update
            if (dateLabels.length === Object.keys(linedata).length) {
              // Define the chart data
              const linechartData = {
                labels: dateLabels, // Use the array of dates as x-axis labels
                datasets: [
                  {
                    label: 'Satisfied',
                    data: satisfiedData,
                    backgroundColor: ['#696cff'],
                    borderColor: ['#696cff'],
                  },
                  {
                    label: 'Neutral',
                    data: neutralData,
                    backgroundColor: ['#ffab00'],
                    borderColor: ['#ffab00'], // Set borderColor to match backgroundColor
                  },
                  {
                    label: 'Not Satisfied',
                    data: notSatisfiedData,
                    backgroundColor: ['#FF3e1d'],
                    borderColor: ['#FF3e1d'], // Set borderColor to match backgroundColor
                  },
                ],
              };

              // Define the chart data
              const stackchartData = {
                labels: dateLabels, // Use the array of dates as x-axis labels
                datasets: [
                  {
                    label: 'Satisfied',
                    data: satisfiedData,
                    backgroundColor: ['#696cff'],
                    borderColor: ['#696cff'],
                  },
                  {
                    label: 'Neutral',
                    data: neutralData,
                    backgroundColor: ['#ffab00'],
                    borderColor: ['#ffab00'], // Set borderColor to match backgroundColor
                  },
                  {
                    label: 'Not Satisfied',
                    data: notSatisfiedData,
                    backgroundColor: ['#FF3e1d'],
                    borderColor: ['#FF3e1d'], // Set borderColor to match backgroundColor
                  },
                ],
              };

              // Define chart options (scales, titles, etc.)
              const options = {
                maintainAspectRatio:false,
                scales: {
                  x: {
                    title: {
                      display: true,
                      text: 'Date of Usage',
                      beginAtZero: true,
                      max:100,
                    },
                    //maxTicksLimit: 10,  // Set the maximum number of visible ticks on the x-axis
                    //max: 1000,            // Set the maximum number of labels to display
                  },
                  y: {
                    title: {
                      display: true,
                      text: 'Customer Feedback Percentage',
                      beginAtZero: true,
                      max: 100, // Set the maximum value on the y-axis to 100%
                    },
                  },
                },
              };

              // Define chart options (scales, titles, etc.)
              const stackChartOptions = {
                responsive: true, // Make the chart responsive

                scales: {
                  x: {
                    stacked: true,
                    title: {
                      display: true,
                      text: 'Date of Usage',
                      beginAtZero: true,
                    },
                  },
                  y: {
                    stacked: true, 
                    title: {
                      display: true,
                      text: 'Customer Feedback Percentage',
                      beginAtZero: true,
                      max: 100, // Set the maximum value on the y-axis to 100%
                    },
                  },
                },
              };

              // Get the canvas element by ID
              const ctx = document.getElementById('emotionLineChart').getContext('2d');

              // Destroy any existing chart instance on the canvas
              Chart.getChart(ctx)?.destroy();

              // Create the line chart
              const mylineChart = new Chart(ctx, {
                type: 'bar',
                data: linechartData,
                options: options,
              });

              // Get the canvas element by ID
              const ctx1 = document.getElementById('emoStackBarChart').getContext('2d');

              // Destroy any existing chart instance on the canvas
              Chart.getChart(ctx1)?.destroy();

              // Create the line chart
              const mylineChart1 = new Chart(ctx1, {
                type: 'bar',
                data: stackchartData,
                options: stackChartOptions,
              });
              }
            }
        });
      });
    } else {
      console.error('Emotion data is null or undefined.');
    }
  });
}

// Function to fetch data for the current date and calculate the highest percentage
function fetchAndCalculateHighestPercentage() {
  // Determine the current date in the format used in Firebase data
  const currentDate = new Date();

  // Convert the date to a string in the format "YYYY-MM-DD"
  const dateString = currentDate.toISOString().split('T')[0];

  // Create a reference to the emotion data for the current date
  const currentDateDataRef = ref(database, `${dateString}/${userEmail.split('@')[0]}/emotions`);

  // Fetch the emotion data for the current date
  onValue(currentDateDataRef, (snapshot) => {
    const currentDateData = snapshot.val();

    if (currentDateData) {
      // Extract the emotion data for the current date
      const satisfied = currentDateData.happy || 0;
      const neutral = currentDateData.neutral || 0;
      const notSatisfied = currentDateData.angry || 0;

      // Calculate percentages and ensure they don't exceed 100%
      const totalEmotions = satisfied + neutral + notSatisfied;
      const satisfiedPercentage = (satisfied / totalEmotions) * 100;
      const neutralPercentage = (neutral / totalEmotions) * 100;
      const notSatisfiedPercentage = (notSatisfied / totalEmotions) * 100;

      // Determine the emotion with the highest percentage
      let highestEmotion = '';
      let highestPercentage = 0;

      if (satisfiedPercentage >= neutralPercentage && satisfiedPercentage >= notSatisfiedPercentage) {
        highestEmotion = 'Satisfied';
        highestPercentage = satisfiedPercentage;
      } else if (neutralPercentage >= satisfiedPercentage && neutralPercentage >= notSatisfiedPercentage) {
        highestEmotion = 'Neutral';
        highestPercentage = neutralPercentage;
      } else {
        highestEmotion = 'Not Satisfied';
        highestPercentage = notSatisfiedPercentage;
      }

      // Display the highest percentage and corresponding emotion
      const percentageInsight = document.getElementById('percentageInsight');
      const percentageEmotion = document.getElementById('percentageEmotion');
      if (percentageInsight) {
        percentageInsight.textContent = `${Math.round(highestPercentage)}%`;
      }

      if (percentageEmotion){
        percentageEmotion.textContent = `${highestEmotion}`
      }
    }
  });
}

// Call the function to fetch and calculate the highest percentage
fetchAndCalculateHighestPercentage();



// Define the createVerticalBarChart function
function createVerticalBarChart(data) {
  // Get the canvas context
  const ctx = document.getElementById('verticalBarChart').getContext('2d');

  // Check if a Chart instance already exists for the canvas
  const existingChart = Chart.getChart(ctx);

  // If a Chart instance exists, destroy it before creating a new one
  if (existingChart) {
    existingChart.destroy();
  }

  // Create a new Chart instance
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.map(item => convertYearMonthToText(item.label)),
      datasets: [{
        label: 'Monthly Emotions Count',
        data: data.map(item => item.data),
        backgroundColor: '#20c997', // Specify the background color
        barThickness: 15,
        borderRadius: 10,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          beginAtZero: true,
        },
        y: {
          beginAtZero: true,
        },
      },
    },
  });
}
// Function to convert yearMonth to text
function convertYearMonthToText(yearMonth) {
  const [year, month] = yearMonth.split('-');
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  return `${monthNames[Number(month) - 1]}`;
}
// Call the function to fetch data and update the chart
fetchDatesAndChart();

// Define an array to store monthly emotions data
const monthlyEmotionsData = [];

// Function to fetch monthly emotions data for the current user
function fetchMonthlyEmotionsDataForCurrentUser() {
  // Check if there is a currently authenticated user
  const currentUser = auth.currentUser;

  if (currentUser) {
    const userEmail = auth.currentUser.email;
    const usersEmail = userEmail.split('@')[0];

    // Use the correct database reference (`database`) in the `ref` function
    const userDateRef = ref(database);

    onValue(userDateRef, (snapshot) => {
    const dates = snapshot.val();
// Inside the onValue callback, before other logs
console.log('Dates Object:', dates);

    if (dates) {
      // Loop through each date (YYYY-MM-DD)
      for (const dateKey in dates) {
        if (dates.hasOwnProperty(dateKey)) {
          const dateData = dates[dateKey];
          // Initialize the total emotions for the month
          let totalEmotionsForMonth = 0;

    // Log user's data for the current date
    console.log(`User's data for ${dateKey}:`, dateData[usersEmail]);

          // Check if the user's data exists for the current date
          if (dateData[usersEmail]) {
            const userEmotions = dateData[usersEmail].emotions;

            // Calculate and add the total emotions for the day to the monthly count
            const totalEmotionsForDay =
              (userEmotions.happy || 0) +
              (userEmotions.neutral || 0) +
              (userEmotions.angry || 0);

            // Add the daily emotions count to the monthly total
            totalEmotionsForMonth += totalEmotionsForDay;

            // Extract the year and month from the dateKey
            const yearMonth = dateKey.slice(0, 7); // Extract YYYY-MM from the dateKey

            // Check if the month is already in the array
            const existingMonth = monthlyEmotionsData.find((item) => item.label === yearMonth);

            if (existingMonth) {
              // If the month exists in the array, update its total emotions
              existingMonth.data += totalEmotionsForMonth;
            } else {
              // If the month doesn't exist in the array, add it
              monthlyEmotionsData.push({
                label: yearMonth,
                data: totalEmotionsForMonth,
              });
            }
          }
        }
      }
      console.log('Monthly Emotions Data:', monthlyEmotionsData);
        // Create the vertical bar chart based on the number of months
        createVerticalBarChart(monthlyEmotionsData);
      } else {
        console.error('Emotion data is null or undefined.');
      }
    });
  } else {
    console.error('No authenticated user found.');
  }
}

// Example: Call the function to fetch monthly data and update the chart for the current user
fetchMonthlyEmotionsDataForCurrentUser();


// Show the modal when the button is clicked
$('#showModalButton').click(function() {
  $('#exLargeModal').modal('show');
});

// Function to convert yearMonth to text
function convertYearMonthToText(yearMonth) {
  const [year, month] = yearMonth.split('-');
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  return `${monthNames[Number(month) - 1]} ${year}`;
}

// Function to fetch and update chart data for a specific month
function fetchAndUpdateChartDataForMonth(yearMonth) {
  // Check if there is a currently authenticated user
  const user = auth.currentUser;

  if (user) {
    const userEmail = user.email;
    const usersEmail = userEmail.split('@')[0];

    // Use the correct database reference (`database`) in the `ref` function
    const userDateRef = ref(database, `${yearMonth}/${usersEmail}/emotions`);

    // Fetch the emotion data for the selected month and user
    onValue(userDateRef, (snapshot) => {
      const dateData = snapshot.val();

      if (dateData) {
        // Calculate the total emotions for the month
        const totalEmotionsForMonth =
          (dateData?.happy || 0) +
          (dateData?.neutral || 0) +
          (dateData?.angry || 0);

        // Update the chart with the data for the selected month
        updateChart([{ label: yearMonth, data: totalEmotionsForMonth }]);
      } else {
        // Handle the case where data is undefined, set it to null or take appropriate action
        console.error('Emotion data for the selected month is null or undefined.');
      }
    });
  } else {
    console.error('No authenticated user found.');
  }
}

// Example function to update the chart (replace this with your actual chart updating logic)
function updateChart(data) {
  // Your chart updating logic goes here
  console.log('Updating chart with data:', data);

  // Assuming you have the existing chart instance (mylineChart) in the global scope
  // Destroy any existing chart instance
  if (mylineChart) {
    mylineChart.destroy();
  }

  // Create a new chart instance
  const ctx = document.getElementById('emotionLineChart').getContext('2d');
  mylineChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.map((entry) => entry.label),
      datasets: [
        {
          label: 'Total Emotions',
          data: data.map((entry) => entry.data),
          backgroundColor: '#696cff',
          borderColor: '#696cff',
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          title: {
            display: true,
            text: 'Date of Usage',
            beginAtZero: true,
          },
        },
        y: {
          title: {
            display: true,
            text: 'Total Emotions',
            beginAtZero: true,
          },
        },
      },
    },
  });
}
})
    </script>
</body>

</html>